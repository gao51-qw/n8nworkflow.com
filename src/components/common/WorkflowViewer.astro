---
/**
 * WorkflowViewer 组件
 * 路径: src/components/common/WorkflowViewer.astro
 * 
 * 用途: 交互式工作流查看器（支持缩放、拖拽、全屏）
 * 优先级: P0
 * 
 * Props 接口:
 * - workflowImageUrl: string - 工作流图片 URL
 * - workflowName: string - 工作流名称
 * 
 * 特性:
 * - 图片放大/缩小
 * - 鼠标滚轮缩放
 * - 拖拽平移
 * - 全屏模式
 * - 重置按钮
 * - 下载按钮
 */

interface Props {
  workflowImageUrl: string;
  workflowName: string;
}

const { workflowImageUrl, workflowName } = Astro.props;
---

<figure class="w-full bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
  <!-- 工具栏 -->
  <div class="bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3 flex items-center justify-between">
    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">工作流预览</span>
    <div class="flex items-center gap-2">
      <!-- 缩放控制 -->
      <div class="hidden sm:flex items-center gap-1 border border-gray-300 dark:border-gray-600 rounded-lg p-1">
        <button
          class="p-1.5 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition"
          data-action="zoom-out"
          title="缩小 (-)"
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="11" cy="11" r="8" stroke-width="2"></circle>
            <path d="m21 21-4.35-4.35" stroke-width="2"></path>
            <path d="M7 11h8" stroke-width="2"></path>
          </svg>
        </button>
        <span class="text-xs font-medium px-2 py-1 min-w-12 text-center" id="zoom-level">100%</span>
        <button
          class="p-1.5 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition"
          data-action="zoom-in"
          title="放大 (+)"
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="11" cy="11" r="8" stroke-width="2"></circle>
            <path d="m21 21-4.35-4.35" stroke-width="2"></path>
            <path d="M11 8v6m3-3H8" stroke-width="2"></path>
          </svg>
        </button>
      </div>

      <!-- 其他按钮 -->
      <button
        class="p-1.5 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition"
        data-action="fit-canvas"
        title="适应屏幕 (0)"
      >
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18-5h3a2 2 0 0 1 2 2v3M9 21H6a2 2 0 0 1-2-2v-3m18 3v-3h3a2 2 0 0 0 2-2"></path>
        </svg>
      </button>

      <button
        class="p-1.5 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition"
        data-action="reset"
        title="重置 (R)"
      >
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
          <path d="M21 3v5h-5"></path>
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
          <path d="M3 21v-5h5"></path>
        </svg>
      </button>

      <button
        class="p-1.5 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition"
        data-action="fullscreen"
        title="全屏 (F)"
      >
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18-5h3a2 2 0 0 1 2 2v3M9 21H6a2 2 0 0 1-2-2v-3m18 3v-3h3a2 2 0 0 0 2-2"></path>
        </svg>
      </button>

      <button
        class="p-1.5 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition"
        data-action="download"
        title="下载 (D)"
      >
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
      </button>
    </div>
  </div>

  <!-- 图片容器 -->
  <div
    class="relative w-full overflow-hidden bg-white dark:bg-gray-950 aspect-video flex items-center justify-center cursor-grab active:cursor-grabbing"
    id="viewer-container"
  >
    <img
      src={workflowImageUrl}
      alt={workflowName}
      id="workflow-image"
      class="max-w-full max-h-full object-contain select-none"
      onerror="this.src='/placeholder-workflow.svg'"
    />
  </div>
</figure>

<script>
  // TODO: 实现工作流查看器交互逻辑
  // 1. 缩放功能 (滚轮/按钮)
  // 2. 拖拽平移
  // 3. 键盘快捷键 (F=全屏, R=重置, D=下载)
  // 4. 全屏模式
  // 5. 下载功能

  let zoomLevel = 100;
  let isDragging = false;
  let startX = 0;
  let startY = 0;

  const container = document.getElementById('viewer-container');
  const image = document.getElementById('workflow-image');
  const zoomDisplay = document.getElementById('zoom-level');

  // TODO: 添加事件监听器和交互逻辑
  if (container && image) {
    // 监听工具栏按钮
    document.querySelectorAll('[data-action]').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const action = (e.currentTarget as HTMLButtonElement).dataset.action;
        console.log('Workflow viewer action:', action);
        // TODO: 实现各个操作
      });
    });
  }
</script>

<style>
  #viewer-container {
    & img {
      transition: transform 0.2s ease-out;
    }
  }
</style>
