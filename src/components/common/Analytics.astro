---
/**
 * Analytics 组件
 * 集成 Google Analytics 4 和性能监控
 */

// 从环境变量获取 GA Measurement ID
const GA_MEASUREMENT_ID = import.meta.env.PUBLIC_GA_MEASUREMENT_ID;
const ENABLE_ANALYTICS = import.meta.env.ENABLE_ANALYTICS !== 'false';

// 只在生产环境启用
const isProduction = import.meta.env.PROD;
const shouldLoadAnalytics = isProduction && ENABLE_ANALYTICS && GA_MEASUREMENT_ID;
---

{
  shouldLoadAnalytics && (
    <>
      <!-- Google Analytics 4 -->
      <script
        async
        src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`}
      ></script>
      <script
        define:vars={{ GA_MEASUREMENT_ID }}
        is:inline
      >
        window.dataLayer = window.dataLayer || [];
        function gtag() {
          dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', GA_MEASUREMENT_ID, {
          page_path: window.location.pathname,
          anonymize_ip: true,
          cookie_flags: 'SameSite=None;Secure',
        });
      </script>

      <!-- Web Vitals 监控 -->
      <script>
        // 导入性能监控工具
        import { monitorWebVitals } from '@/lib/utils/performance';

        // 监控 Web Vitals 并发送到 GA
        if (typeof window !== 'undefined' && window.gtag) {
          monitorWebVitals((metric) => {
            // 发送到 Google Analytics
            window.gtag('event', metric.name, {
              event_category: 'Web Vitals',
              event_label: metric.id,
              value: Math.round(metric.value),
              metric_rating: metric.rating,
              non_interaction: true,
            });

            // 在开发环境打印到控制台
            if (import.meta.env.DEV) {
              console.log(`[Web Vitals] ${metric.name}:`, {
                value: metric.value,
                rating: metric.rating,
              });
            }
          });
        }

        // 自定义事件追踪
        window.trackEvent = function (eventName, eventParams = {}) {
          if (window.gtag) {
            window.gtag('event', eventName, eventParams);
          }
        };

        // 页面浏览追踪（用于 SPA 导航）
        window.trackPageView = function (path) {
          if (window.gtag) {
            window.gtag('config', window.GA_MEASUREMENT_ID, {
              page_path: path,
            });
          }
        };

        // 错误追踪
        window.addEventListener('error', (event) => {
          if (window.gtag) {
            window.gtag('event', 'exception', {
              description: event.message,
              fatal: false,
            });
          }
        });

        // 未处理的 Promise 拒绝追踪
        window.addEventListener('unhandledrejection', (event) => {
          if (window.gtag) {
            window.gtag('event', 'exception', {
              description: event.reason,
              fatal: false,
            });
          }
        });

        // 追踪外部链接点击
        document.addEventListener('click', (event) => {
          const link = event.target.closest('a');
          if (link && link.hostname !== window.location.hostname) {
            if (window.gtag) {
              window.gtag('event', 'click', {
                event_category: 'Outbound Link',
                event_label: link.href,
                transport_type: 'beacon',
              });
            }
          }
        });

        // 追踪下载按钮点击
        document.addEventListener('click', (event) => {
          const button = event.target.closest('[data-track-download]');
          if (button) {
            const workflowId = button.dataset.workflowId;
            const workflowTitle = button.dataset.workflowTitle;
            if (window.gtag) {
              window.gtag('event', 'download', {
                event_category: 'Workflow',
                event_label: workflowTitle,
                workflow_id: workflowId,
              });
            }
          }
        });

        // 追踪搜索
        const searchForm = document.querySelector('form[action="/search"]');
        if (searchForm) {
          searchForm.addEventListener('submit', (event) => {
            const searchInput = searchForm.querySelector('input[name="q"]');
            if (searchInput && window.gtag) {
              window.gtag('event', 'search', {
                search_term: searchInput.value,
              });
            }
          });
        }

        // 追踪滚动深度
        let maxScrollDepth = 0;
        let scrollTimeout;
        
        window.addEventListener('scroll', () => {
          clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(() => {
            const scrollDepth = Math.round(
              (window.scrollY + window.innerHeight) / document.body.scrollHeight * 100
            );
            
            if (scrollDepth > maxScrollDepth) {
              maxScrollDepth = scrollDepth;
              
              // 每 25% 发送一次事件
              if (scrollDepth >= 25 && scrollDepth < 50 && maxScrollDepth < 50) {
                window.trackEvent('scroll_depth', { depth: '25%' });
              } else if (scrollDepth >= 50 && scrollDepth < 75 && maxScrollDepth < 75) {
                window.trackEvent('scroll_depth', { depth: '50%' });
              } else if (scrollDepth >= 75 && scrollDepth < 100 && maxScrollDepth < 100) {
                window.trackEvent('scroll_depth', { depth: '75%' });
              } else if (scrollDepth >= 100) {
                window.trackEvent('scroll_depth', { depth: '100%' });
              }
            }
          }, 100);
        });

        // 追踪页面停留时间
        let startTime = Date.now();
        
        window.addEventListener('beforeunload', () => {
          const timeOnPage = Math.round((Date.now() - startTime) / 1000);
          if (window.gtag && timeOnPage > 0) {
            window.gtag('event', 'timing_complete', {
              name: 'time_on_page',
              value: timeOnPage,
              event_category: 'Engagement',
            });
          }
        });

        // 追踪页面可见性变化
        document.addEventListener('visibilitychange', () => {
          if (window.gtag) {
            window.gtag('event', document.hidden ? 'page_hidden' : 'page_visible', {
              event_category: 'Engagement',
            });
          }
        });
      </script>
    </>
  )
}

{
  !shouldLoadAnalytics && import.meta.env.DEV && (
    <script>
      console.log('[Analytics] Disabled in development mode');
    </script>
  )
}

<!-- TypeScript 类型声明 -->
<script is:inline>
  // 全局类型声明
  if (typeof window !== 'undefined') {
    window.gtag = window.gtag || function() {};
    window.trackEvent = window.trackEvent || function() {};
    window.trackPageView = window.trackPageView || function() {};
  }
</script>
