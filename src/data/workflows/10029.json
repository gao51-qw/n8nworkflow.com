{
  "id": 10029,
  "slug": "10029",
  "title": "Automate invoice processing with OCR, GPT-4 & Salesforce opportunity creation",
  "description": "# PDF Invoice Extractor (AI)\n\nEnd-to-end pipeline: Watch Drive ‚ûú Download PDF ‚ûú OCR text ‚ûú AI normalize to JSON ‚ûú Upsert Buyer (Account) ‚ûú Create Opportunity ‚ûú Map Products ‚ûú Create OLI via Composite API ‚ûú Archive to OneDrive.\n\n---\n\n## Node by node (what it does & key setup)\n\n### 1) Google Drive Trigger\n- **Purpose**: Fire when a new file appears in a specific Google Drive folder.\n- **Key settings**:\n  - Event: `fileCreated`\n  - Folder ID: `google drive folder id`\n  - Polling: `everyMinute`\n  - Creds: `googleDriveOAuth2Api`\n- **Output**: Metadata `{ id, name, ... }` for the new file.\n\n---\n\n### 2) Download File From Google\n- **Purpose**: Get the file binary for processing and archiving.\n- **Key settings**:\n  - Operation: `download`\n  - File ID: `={{ $json.id }}`\n  - Creds: `googleDriveOAuth2Api`\n- **Output**: Binary (default key: `data`) and original metadata.\n\n---\n\n### 3) Extract from File\n- **Purpose**: Extract text from PDF (OCR as needed) for AI parsing.\n- **Key settings**:\n  - Operation: `pdf`\n  - OCR: enable for scanned PDFs (in **options**)\n- **Output**: JSON with OCR text at `{{ $json.text }}`.\n\n---\n\n### 4) Message a model (AI JSON Extractor)\n- **Purpose**: Convert OCR text into **strict normalized JSON array** (invoice schema).\n- **Key settings**:\n  - Node: `@n8n/n8n-nodes-langchain.openAi`\n  - Model: `gpt-4.1` (or `gpt-4.1-mini`)\n  - Message role: **system** (the strict prompt; references `{{ $json.text }}`)\n  - `jsonOutput`: `true`\n  - Creds: `openAiApi`\n- **Output (per item)**: `$.message.content` ‚Üí the parsed **JSON** (ensure it‚Äôs an array).\n\n---\n\n### 5) Create or update an account (Salesforce)\n- **Purpose**: Upsert **Buyer** as Account using an external ID.\n- **Key settings**:\n  - Resource: `account`\n  - Operation: `upsert`\n  - External Id Field: `tax_id__c`\n  - External Id Value: `={{ $json.message.content.buyer.tax_id }}`\n  - Name: `={{ $json.message.content.buyer.name }}`\n  - Creds: `salesforceOAuth2Api`\n- **Output**: Account record (captures `Id`) for downstream **Opportunity**.\n\n---\n\n### 6) Create an opportunity (Salesforce)\n- **Purpose**: Create Opportunity linked to the Buyer (Account).\n- **Key settings**:\n  - Resource: `opportunity`\n  - Name: `={{ $('Message a model').item.json.message.content.invoice.code }}`\n  - Close Date: `={{ $('Message a model').item.json.message.content.invoice.issue_date }}`\n  - Stage: `Closed Won`\n  - Amount: `={{ $('Message a model').item.json.message.content.summary.grand_total }}`\n  - AccountId: `={{ $json.id }}` (from **Upsert Account** output)\n  - Creds: `salesforceOAuth2Api`\n- **Output**: Opportunity `Id` for OLI creation.\n\n---\n\n### 7) Build SOQL (Code / JS)\n- **Purpose**: Collect unique product **codes** from AI JSON and build a SOQL query for **PricebookEntry** by `Pricebook2Id`.\n- **Key settings**:\n  - `pricebook2Id` (hardcoded in script): e.g., `01sxxxxxxxxxxxxxxx`\n  - Source lines: `$('Message a model').first().json.message.content.products`\n- **Output**: `{ soql, codes }`\n\n---\n\n### 8) Query PricebookEntries (Salesforce)\n- **Purpose**: Fetch `PricebookEntry.Id` for each `Product2.ProductCode`.\n- **Key settings**:\n  - Resource: `search`\n  - Query: `={{ $json.soql }}`\n  - Creds: `salesforceOAuth2Api`\n- **Output**: Items with `Id`, `Product2.ProductCode` (used for mapping).\n\n---\n\n### 9) Code in JavaScript (Build OLI payloads)\n- **Purpose**: Join lines with PBE results and Opportunity `Id` ‚ûú build **OpportunityLineItem** payloads.\n- **Inputs**:\n  - OpportunityId: `={{ $('Create an opportunity').first().json.id }}`\n  - Lines: `={{ $('Message a model').first().json.message.content.products }}`\n  - PBE rows: from previous node items\n- **Output**: `{ body: { allOrNone:false, records:[{ OpportunityLineItem... }] } }`\n- **Notes**:\n  - Converts discount_total ‚ûú per-unit if needed (currently commented for standard pricing).\n  - Throws on missing PBE mapping or empty lines.\n\n---\n\n### 10) Create Opportunity Line Items (HTTP Request)\n- **Purpose**: Bulk create OLIs via Salesforce Composite API.\n- **Key settings**:\n  - Method: `POST`\n  - URL: `https://&lt;your-instance&gt;.my.salesforce.com/services/data/v65.0/composite/sobjects`\n  - Auth: `salesforceOAuth2Api` (predefined credential)\n  - Body (JSON): `={{ $json.body }}`\n- **Output**: Composite API results (per-record statuses).\n\n---\n\n### 11) Update File to One Drive\n- **Purpose**: Archive the **original** PDF in OneDrive.\n- **Key settings**:\n  - Operation: `upload`\n  - File Name: `={{ $json.name }}`\n  - Parent Folder ID: `onedrive folder id`\n  - Binary Data: `true` (from the Download node)\n  - Creds: `microsoftOneDriveOAuth2Api`\n- **Output**: Uploaded file metadata.\n\n---\n\n## Data flow (wiring)\n\n1. **Google Drive Trigger** ‚Üí **Download File From Google**\n2. **Download File From Google**\n   - ‚Üí **Extract from File**\n   - ‚Üí **Update File to One Drive**\n3. **Extract from File** ‚Üí **Message a model**\n4. **Message a model**\n   - ‚Üí **Create or update an account**\n5. **Create or update an account** ‚Üí **Create an opportunity**\n6. **Create an opportunity** ‚Üí **Build SOQL**\n7. **Build SOQL** ‚Üí **Query PricebookEntries**\n8. **Query PricebookEntries** ‚Üí **Code in JavaScript**\n9. **Code in JavaScript** ‚Üí **Create Opportunity Line Items**\n\n---\n\n## Quick setup checklist\n\n- üîê **Credentials**: Connect Google Drive, OneDrive, Salesforce, OpenAI.\n- üìÇ **IDs**:\n  - Drive Folder ID (watch)\n  - OneDrive Parent Folder ID (archive)\n  - Salesforce **Pricebook2Id** (in the JS SOQL builder)\n- üß† **AI Prompt**: Use the strict system prompt; **jsonOutput = true**.\n- üßæ **Field mappings**:\n  - Buyer tax id/name ‚Üí Account upsert fields\n  - Invoice code/date/amount ‚Üí Opportunity fields\n  - Product `name` must equal your **Product2.ProductCode** in SF.\n- ‚úÖ **Test**: Drop a sample PDF ‚Üí verify:\n  - AI returns **array JSON** only\n  - Account/Opportunity created\n  - OLI records created\n  - PDF archived to OneDrive\n\n---\n\n## Notes & best practices\n\n- If PDFs are scans, enable OCR in **Extract from File**.\n- If AI returns non-JSON, keep ‚Äú**Return only a JSON array**‚Äù as the last line of the prompt and keep `jsonOutput` enabled.\n- Consider adding validation on `parsing.warnings` to gate Salesforce writes.\n- For discounts/taxes in OLI:\n  - Standard OLI fields don‚Äôt support per-line discount amounts directly; model them in **UnitPrice** or custom fields.\n- Replace the Composite API **URL** with your org‚Äôs domain or use the Salesforce node‚Äôs **Bulk Upsert** for simplicity.\n",
  "featuredImage": "/data/workflows/10029/10029.webp",
  "author": {
    "id": 101,
    "slug": "leeseifer",
    "name": "Le Nguyen",
    "avatar": ""
  },
  "categories": [
    "Invoice Processing",
    "AI Summarization"
  ],
  "complexityLevel": "advanced",
  "price": 0,
  "visitors": 848,
  "downloads": 84,
  "createdAt": "2025-10-22T08:03:30.124Z",
  "updatedAt": "2026-01-16T09:03:02.094Z",
  "publishedAt": "2025-10-22T08:03:30.124Z",
  "nodes": 23,
  "version": "1.0.0",
  "sourceUrl": "https://n8n.io/workflows/10029",
  "disclaimer": "This workflow is provided as-is. Please review and test before using in production.",
  "overview": {
    "title": "Automate invoice processing with OCR, GPT-4 & Salesforce opportunity creation",
    "workflowName": "Automate invoice processing with OCR, GPT-4 & Salesforce opportunity creation",
    "description": "# PDF Invoice Extractor (AI)\n\nEnd-to-end pipeline: Watch Drive ‚ûú Download PDF ‚ûú OCR text ‚ûú AI normalize to JSON ‚ûú Upsert Buyer (Account) ‚ûú Create Opportunity ‚ûú Map Products ‚ûú Create OLI via Composite API ‚ûú Archive to OneDrive.\n\n---\n\n## Node by node (what it does & key setup)\n\n### 1) Google Drive Trigger\n- **Purpose**: Fire when a new file appears in a specific Google Drive folder.\n- **Key settings**:\n  - Event: `fileCreated`\n  - Folder ID: `google drive folder id`\n  - Polling: `everyMinute`\n  - Creds: `googleDriveOAuth2Api`\n- **Output**: Metadata `{ id, name, ... }` for the new file.\n\n---\n\n### 2) Download File From Google\n- **Purpose**: Get the file binary for processing and archiving.\n- **Key settings**:\n  - Operation: `download`\n  - File ID: `={{ $json.id }}`\n  - Creds: `googleDriveOAuth2Api`\n- **Output**: Binary (default key: `data`) and original metadata.\n\n---\n\n### 3) Extract from File\n- **Purpose**: Extract text from PDF (OCR as needed) for AI parsing.\n- **Key settings**:\n  - Operation: `pdf`\n  - OCR: enable for scanned PDFs (in **options**)\n- **Output**: JSON with OCR text at `{{ $json.text }}`.\n\n---\n\n### 4) Message a model (AI JSON Extractor)\n- **Purpose**: Convert OCR text into **strict normalized JSON array** (invoice schema).\n- **Key settings**:\n  - Node: `@n8n/n8n-nodes-langchain.openAi`\n  - Model: `gpt-4.1` (or `gpt-4.1-mini`)\n  - Message role: **system** (the strict prompt; references `{{ $json.text }}`)\n  - `jsonOutput`: `true`\n  - Creds: `openAiApi`\n- **Output (per item)**: `$.message.content` ‚Üí the parsed **JSON** (ensure it‚Äôs an array).\n\n---\n\n### 5) Create or update an account (Salesforce)\n- **Purpose**: Upsert **Buyer** as Account using an external ID.\n- **Key settings**:\n  - Resource: `account`\n  - Operation: `upsert`\n  - External Id Field: `tax_id__c`\n  - External Id Value: `={{ $json.message.content.buyer.tax_id }}`\n  - Name: `={{ $json.message.content.buyer.name }}`\n  - Creds: `salesforceOAuth2Api`\n- **Output**: Account record (captures `Id`) for downstream **Opportunity**.\n\n---\n\n### 6) Create an opportunity (Salesforce)\n- **Purpose**: Create Opportunity linked to the Buyer (Account).\n- **Key settings**:\n  - Resource: `opportunity`\n  - Name: `={{ $('Message a model').item.json.message.content.invoice.code }}`\n  - Close Date: `={{ $('Message a model').item.json.message.content.invoice.issue_date }}`\n  - Stage: `Closed Won`\n  - Amount: `={{ $('Message a model').item.json.message.content.summary.grand_total }}`\n  - AccountId: `={{ $json.id }}` (from **Upsert Account** output)\n  - Creds: `salesforceOAuth2Api`\n- **Output**: Opportunity `Id` for OLI creation.\n\n---\n\n### 7) Build SOQL (Code / JS)\n- **Purpose**: Collect unique product **codes** from AI JSON and build a SOQL query for **PricebookEntry** by `Pricebook2Id`.\n- **Key settings**:\n  - `pricebook2Id` (hardcoded in script): e.g., `01sxxxxxxxxxxxxxxx`\n  - Source lines: `$('Message a model').first().json.message.content.products`\n- **Output**: `{ soql, codes }`\n\n---\n\n### 8) Query PricebookEntries (Salesforce)\n- **Purpose**: Fetch `PricebookEntry.Id` for each `Product2.ProductCode`.\n- **Key settings**:\n  - Resource: `search`\n  - Query: `={{ $json.soql }}`\n  - Creds: `salesforceOAuth2Api`\n- **Output**: Items with `Id`, `Product2.ProductCode` (used for mapping).\n\n---\n\n### 9) Code in JavaScript (Build OLI payloads)\n- **Purpose**: Join lines with PBE results and Opportunity `Id` ‚ûú build **OpportunityLineItem** payloads.\n- **Inputs**:\n  - OpportunityId: `={{ $('Create an opportunity').first().json.id }}`\n  - Lines: `={{ $('Message a model').first().json.message.content.products }}`\n  - PBE rows: from previous node items\n- **Output**: `{ body: { allOrNone:false, records:[{ OpportunityLineItem... }] } }`\n- **Notes**:\n  - Converts discount_total ‚ûú per-unit if needed (currently commented for standard pricing).\n  - Throws on missing PBE mapping or empty lines.\n\n---\n\n### 10) Create Opportunity Line Items (HTTP Request)\n- **Purpose**: Bulk create OLIs via Salesforce Composite API.\n- **Key settings**:\n  - Method: `POST`\n  - URL: `https://&lt;your-instance&gt;.my.salesforce.com/services/data/v65.0/composite/sobjects`\n  - Auth: `salesforceOAuth2Api` (predefined credential)\n  - Body (JSON): `={{ $json.body }}`\n- **Output**: Composite API results (per-record statuses).\n\n---\n\n### 11) Update File to One Drive\n- **Purpose**: Archive the **original** PDF in OneDrive.\n- **Key settings**:\n  - Operation: `upload`\n  - File Name: `={{ $json.name }}`\n  - Parent Folder ID: `onedrive folder id`\n  - Binary Data: `true` (from the Download node)\n  - Creds: `microsoftOneDriveOAuth2Api`\n- **Output**: Uploaded file metadata.\n\n---\n\n## Data flow (wiring)\n\n1. **Google Drive Trigger** ‚Üí **Download File From Google**\n2. **Download File From Google**\n   - ‚Üí **Extract from File**\n   - ‚Üí **Update File to One Drive**\n3. **Extract from File** ‚Üí **Message a model**\n4. **Message a model**\n   - ‚Üí **Create or update an account**\n5. **Create or update an account** ‚Üí **Create an opportunity**\n6. **Create an opportunity** ‚Üí **Build SOQL**\n7. **Build SOQL** ‚Üí **Query PricebookEntries**\n8. **Query PricebookEntries** ‚Üí **Code in JavaScript**\n9. **Code in JavaScript** ‚Üí **Create Opportunity Line Items**\n\n---\n\n## Quick setup checklist\n\n- üîê **Credentials**: Connect Google Drive, OneDrive, Salesforce, OpenAI.\n- üìÇ **IDs**:\n  - Drive Folder ID (watch)\n  - OneDrive Parent Folder ID (archive)\n  - Salesforce **Pricebook2Id** (in the JS SOQL builder)\n- üß† **AI Prompt**: Use the strict system prompt; **jsonOutput = true**.\n- üßæ **Field mappings**:\n  - Buyer tax id/name ‚Üí Account upsert fields\n  - Invoice code/date/amount ‚Üí Opportunity fields\n  - Product `name` must equal your **Product2.ProductCode** in SF.\n- ‚úÖ **Test**: Drop a sample PDF ‚Üí verify:\n  - AI returns **array JSON** only\n  - Account/Opportunity created\n  - OLI records created\n  - PDF archived to OneDrive\n\n---\n\n## Notes & best practices\n\n- If PDFs are scans, enable OCR in **Extract from File**.\n- If AI returns non-JSON, keep ‚Äú**Return only a JSON array**‚Äù as the last line of the prompt and keep `jsonOutput` enabled.\n- Consider adding validation on `parsing.warnings` to gate Salesforce writes.\n- For discounts/taxes in OLI:\n  - Standard OLI fields don‚Äôt support per-line discount amounts directly; model them in **UnitPrice** or custom fields.\n- Replace the Composite API **URL** with your org‚Äôs domain or use the Salesforce node‚Äôs **Bulk Upsert** for simplicity.",
    "features": [],
    "useCases": []
  },
  "logicalBlocks": [],
  "nodeDetails": [
    {
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "role": "stickyNote",
      "configDescription": "Version 1"
    },
    {
      "name": "Extract from File",
      "type": "n8n-nodes-base.extractFromFile",
      "role": "extractFromFile",
      "configDescription": "Version 1"
    },
    {
      "name": "Google Drive Trigger",
      "type": "n8n-nodes-base.googleDriveTrigger",
      "role": "googleDriveTrigger",
      "configDescription": "Version 1"
    },
    {
      "name": "Message a model",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "role": "openAi",
      "configDescription": "Version 1.8"
    },
    {
      "name": "Download File From Google",
      "type": "n8n-nodes-base.googleDrive",
      "role": "googleDrive",
      "configDescription": "Version 3"
    },
    {
      "name": "Update File to One Drive",
      "type": "n8n-nodes-base.microsoftOneDrive",
      "role": "microsoftOneDrive",
      "configDescription": "Version 1"
    },
    {
      "name": "Create an opportunity",
      "type": "n8n-nodes-base.salesforce",
      "role": "salesforce",
      "configDescription": "Version 1"
    },
    {
      "name": "Create or update an account",
      "type": "n8n-nodes-base.salesforce",
      "role": "salesforce",
      "configDescription": "Version 1"
    },
    {
      "name": "Build SOQL",
      "type": "n8n-nodes-base.code",
      "role": "code",
      "configDescription": "Version 2"
    },
    {
      "name": "Query PricebookEntries",
      "type": "n8n-nodes-base.salesforce",
      "role": "salesforce",
      "configDescription": "Version 1"
    },
    {
      "name": "Code in JavaScript",
      "type": "n8n-nodes-base.code",
      "role": "code",
      "configDescription": "Version 2"
    },
    {
      "name": "Create Opportunity Line Items",
      "type": "n8n-nodes-base.httpRequest",
      "role": "httpRequest",
      "configDescription": "Version 4.2"
    },
    {
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "role": "stickyNote",
      "configDescription": "Version 1"
    },
    {
      "name": "Sticky Note2",
      "type": "n8n-nodes-base.stickyNote",
      "role": "stickyNote",
      "configDescription": "Version 1"
    },
    {
      "name": "Sticky Note3",
      "type": "n8n-nodes-base.stickyNote",
      "role": "stickyNote",
      "configDescription": "Version 1"
    },
    {
      "name": "Sticky Note4",
      "type": "n8n-nodes-base.stickyNote",
      "role": "stickyNote",
      "configDescription": "Version 1"
    },
    {
      "name": "Sticky Note5",
      "type": "n8n-nodes-base.stickyNote",
      "role": "stickyNote",
      "configDescription": "Version 1"
    },
    {
      "name": "Sticky Note6",
      "type": "n8n-nodes-base.stickyNote",
      "role": "stickyNote",
      "configDescription": "Version 1"
    },
    {
      "name": "Sticky Note7",
      "type": "n8n-nodes-base.stickyNote",
      "role": "stickyNote",
      "configDescription": "Version 1"
    },
    {
      "name": "Sticky Note8",
      "type": "n8n-nodes-base.stickyNote",
      "role": "stickyNote",
      "configDescription": "Version 1"
    },
    {
      "name": "Sticky Note9",
      "type": "n8n-nodes-base.stickyNote",
      "role": "stickyNote",
      "configDescription": "Version 1"
    },
    {
      "name": "Sticky Note10",
      "type": "n8n-nodes-base.stickyNote",
      "role": "stickyNote",
      "configDescription": "Version 1"
    },
    {
      "name": "Sticky Note11",
      "type": "n8n-nodes-base.stickyNote",
      "role": "stickyNote",
      "configDescription": "Version 1"
    }
  ]
}