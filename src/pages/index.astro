---
/**
 * 首页 - 展示所有工作流
 * 完整的首页布局，包含 Hero、统计、工作流网格和分页
 */

import MainLayout from '../layouts/MainLayout.astro';
import WorkflowGrid from '../components/workflow/WorkflowGrid.astro';
import FilterSidebar from '../components/ui/FilterSidebar.astro';
import Pagination from '../components/ui/Pagination.astro';
import SearchBar from '../components/ui/SearchBar.astro';
import AdRow from '../components/ui/AdRow.astro';
import { getWorkflows, getFilterCountsV2 } from '../lib/services/workflows';
import { getStats } from '../lib/services/stats';
import { formatLongDate } from '../lib/utils/date';
import { generateHeroContent } from '../lib/services/content-generator';
import { generateWebSiteSchema, generateOrganizationSchema, combineSchemas } from '../lib/utils/schema';
import type { Workflow } from '../lib/types/workflow';

export const prerender = false;

// 获取分页参数和过滤参数
const currentPage = Math.max(1, parseInt(Astro.url.searchParams.get('page') || '1', 10));
const timeFilter = Astro.url.searchParams.get('time') || undefined;
const priceFilter = Astro.url.searchParams.get('price') as 'free' | 'paid' | undefined;
const categoryFilter = Astro.url.searchParams.get('category') || undefined;
const complexityFilter = Astro.url.searchParams.get('complexity') || undefined;

// 构建基础 URL，保留现有的筛选参数（除了 page）
const baseUrl = new URL(Astro.url);
baseUrl.searchParams.delete('page');
// 确保 baseUrl 包含 search 部分，如果 search 为空则不加 ?
const paginationBaseUrl = baseUrl.pathname + (baseUrl.search ? baseUrl.search : '');

// 构建当前过滤器对象
const currentFilters = {
  timePeriod: timeFilter,
  price: priceFilter,
  category: categoryFilter,
  complexity: complexityFilter,
};

const pageSize = 12;
const offset = (currentPage - 1) * pageSize;

// 获取工作流数据
let workflows: Workflow[] = [];
let totalCount = 0;

try {
  const result = await getWorkflows({
    sort: 'date-desc',
    limit: pageSize,
    offset: offset,
    time: timeFilter,
    price: priceFilter,
    category: categoryFilter,
    complexity: complexityFilter,
  });
  workflows = result.workflows;
  totalCount = result.total;
} catch (error) {
  console.error('Error fetching workflows:', error);
}

// 获取筛选计数数据
let filterCounts: any = {
  timePeriods: { all: 7947, '7d': 8, '1m': 374, '6m': 4508, '1y': 6758 },
  categories: { 'multimodal-ai': 2270, ai: 1600 },
  complexities: { all: 7947, beginner: 500, intermediate: 2835, advanced: 4602 },
  price: { all: 7947, free: 6898, paid: 1049 },
};

try {
  filterCounts = await getFilterCountsV2({
    timePeriod: timeFilter,
    price: priceFilter,
    category: categoryFilter,
    complexity: complexityFilter,
  });
} catch (error) {
  console.error('Error fetching filter counts:', error);
}

// 获取Hero内容
let heroContent = {
  title: 'Discover Powerful N8N Workflows',
  subtitle: 'Browse thousands of automation workflows created by the community. Save time and boost productivity with ready-to-use workflows.',
  stats: {
    workflows: '1,000+',
    authors: '100+',
    recent: '50+',
  },
};

try {
  heroContent = await generateHeroContent();
} catch (error) {
  console.error('Error generating hero content:', error);
}

// 获取统计数据
let stats: any = {
  totalWorkflows: 7943,
  totalAuthors: 1250,
  totalCategories: 45,
  totalDownloads: 150000,
  recentWorkflows: 50,
  lastUpdatedAt: new Date().toISOString(),
};

try {
  const fetchedStats = await getStats();
  stats = { ...stats, ...fetchedStats };
  
  // 同步更新 Hero 内容中的统计数据
  heroContent.stats = {
    workflows: `${Math.floor(stats.totalWorkflows / 100) * 100}+`,
    authors: `${Math.floor(stats.totalAuthors / 10) * 10}+`,
    recent: `${stats.recentWorkflows}+`,
  };
} catch (error) {
  console.error('Error fetching stats:', error);
}

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://n8nworkflow.com';

// 生成结构化数据
const websiteSchema = generateWebSiteSchema(siteUrl);
const organizationSchema = generateOrganizationSchema(siteUrl);
const combinedSchema = combineSchemas(websiteSchema, organizationSchema);

// SEO 配置
const seoConfig = {
  title: 'N8N Workflows - Discover Automation Workflows',
  description: 'Browse thousands of n8n automation workflows created by the community. Find workflows for email automation, data sync, notifications, and more.',
  canonical: '/',
  schema: combinedSchema,
};

// 计算总页数
const totalPages = Math.ceil(totalCount / pageSize);
---
<MainLayout {...seoConfig}>
  <div class="w-full min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Hero Section -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4">
          N8N Workflows Catalog
        </h1>
        <div class="inline-block px-4 py-1.5 bg-white dark:bg-gray-800 rounded-full border border-gray-200 dark:border-gray-700 text-sm font-medium text-gray-700 dark:text-gray-400 mb-6 shadow-sm">
          {stats.totalWorkflows.toLocaleString()} workflows available (updated {formatLongDate(stats.lastUpdatedAt || new Date())})
        </div>
        <p class="text-lg text-gray-700 dark:text-gray-300 max-w-2xl mx-auto">
          Discover ready-to-use automation workflows to optimize your processes.
        </p>
      </div>

      <!-- Newsletter Section -->
      <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-8 mb-12 shadow-sm">
        <div class="flex flex-col md:flex-row items-center gap-8">
          <div class="flex-1 text-center md:text-left">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Subscribe to our newsletter</h2>
            <p class="text-sm text-gray-600 dark:text-gray-400">Get the latest updates and new workflows delivered to your inbox.</p>
          </div>
          <div class="w-full md:w-auto flex flex-col sm:flex-row gap-3">
            <label for="hero-newsletter-email" class="sr-only">Email address</label>
            <input
              type="email"
              id="hero-newsletter-email"
              placeholder="Enter your email"
              class="px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 focus:ring-2 focus:ring-primary-500 outline-none min-w-[280px]"
            />
            <button class="px-8 py-3 bg-gray-900 dark:bg-white text-white dark:text-gray-900 rounded-xl font-bold hover:bg-gray-800 dark:hover:bg-gray-100 transition-colors">
              Subscribe
            </button>
          </div>
        </div>
        <p class="text-[10px] text-gray-600 dark:text-gray-500 mt-4 text-center md:text-left">
          By subscribing, you agree to receive updates. You can unsubscribe at any time.
        </p>
      </div>

      <!-- Search Bar -->
      <div class="max-w-4xl mx-auto mb-12">
        <SearchBar placeholder="Search for a workflow..." />
      </div>

      <!-- Promo/Ads Row -->
      <AdRow variant="simple" />

      <!-- Main Content - 2 Column Layout -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Mobile Filter Toggle -->
        <div class="lg:hidden mb-4">
          <button
            id="mobile-filter-toggle"
            class="w-full flex items-center justify-center gap-2 py-3 px-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl font-bold text-gray-900 dark:text-white shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
          >
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            <span>Filters & Resources</span>
          </button>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar-content" class="hidden lg:block lg:col-span-3 space-y-8">
          <!-- Buy me a coffee -->
          <a href="https://s.n8nworkflows.xyz/YBc9Q" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-2 w-full py-3 px-4 bg-[#FFDD00] text-black rounded-xl font-bold hover:bg-[#FFCC00] transition-colors shadow-sm">
            <img src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" alt="BMC" class="w-5 h-5" />
            <span>Buy me a coffee</span>
          </a>

          <!-- Share CTA -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm text-center">
            <div class="w-12 h-12 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">✨</div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Share Your Workflow</h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Have a great workflow to share? Join the n8n Creator Hub and help the community!</p>
            <div class="space-y-3">
              <a href="#" class="block w-full py-2 px-4 bg-primary-700 text-white rounded-lg font-bold text-sm hover:bg-primary-800 transition-colors">Submit Your Template</a>
              <a href="#" class="block w-full py-2 px-4 text-gray-700 dark:text-gray-400 font-bold text-sm hover:text-gray-900 dark:hover:text-white transition-colors">How to Submit</a>
            </div>
          </div>

          <!-- Filter Sidebar Component -->
          <FilterSidebar 
            filterCounts={filterCounts} 
            currentFilters={currentFilters} 
          />
        </aside>

        <!-- Workflow Grid -->
        <div class="lg:col-span-9">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
              Latest Workflows
            </h2>
            <div class="flex items-center gap-4">
              <label for="sort-select-hero" class="text-sm text-gray-700 dark:text-gray-400">Sort by:</label>
              <select id="sort-select-hero" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-primary-500">
                <option>Date (newest → oldest)</option>
                <option>Date (oldest → newest)</option>
                <option>Visits (high → low)</option>
                <option>Downloads (high → low)</option>
              </select>
            </div>
          </div>

          {workflows.length > 0 ? (
            <>
              <WorkflowGrid workflows={workflows} columns={3} />
              <div class="mt-12">
                <Pagination
                  currentPage={currentPage}
                  totalPages={totalPages}
                  baseUrl={paginationBaseUrl}
                />
              </div>
            </>
          ) : (
            <div class="text-center py-24 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm">
              <p class="text-gray-600 dark:text-gray-400">No workflows found matching your criteria.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</MainLayout>

<script>
  // Mobile Filter Toggle Logic
  const toggleBtn = document.getElementById('mobile-filter-toggle');
  const sidebar = document.getElementById('sidebar-content');

  if (toggleBtn && sidebar) {
    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('hidden');
      const isHidden = sidebar.classList.contains('hidden');
      toggleBtn.querySelector('span')!.textContent = isHidden ? 'Filters & Resources' : 'Close Filters';
    });
  }
</script>
