---
/**
 * Â∑•‰ΩúÊµÅËØ¶ÊÉÖÈ°µÔºàÂä®ÊÄÅË∑ØÁî±Ôºâ
 * Â±ïÁ§∫Âçï‰∏™Â∑•‰ΩúÊµÅÁöÑÂÆåÊï¥‰ø°ÊÅØ
 */

import MainLayout from '../../layouts/MainLayout.astro';
import WorkflowDetail from '../../components/workflow/WorkflowDetail.astro';
import WorkflowDetailedView from '../../components/workflow/WorkflowDetailedView.astro';
import WorkflowMeta from '../../components/workflow/WorkflowMeta.astro';
import RelatedWorkflows from '../../components/workflow/RelatedWorkflows.astro';
import Breadcrumb from '../../components/ui/Breadcrumb.astro';
import { getWorkflows, getWorkflowBySlug, getWorkflowDetailedById } from '../../lib/services/workflows';

// ÁîüÊàêÈùôÊÄÅË∑ØÂæÑ
export async function getStaticPaths() {
  try {
    const result = await getWorkflows({ limit: 100, offset: 0 });
    return result.workflows.map((workflow) => ({
      params: { slug: workflow.slug },
      props: { workflow },
    }));
  } catch (error) {
    console.error('Error generating workflow paths:', error);
    return [];
  }
}

const { slug } = Astro.params;
let { workflow } = Astro.props;

// Ëé∑ÂèñËØ¶ÁªÜÂ∑•‰ΩúÊµÅ‰ø°ÊÅØÔºàÂê´ÁªìÊûÑÂåñÂÜÖÂÆπÔºâ
let workflowDetailed = workflow;
try {
  if (workflow.id) {
    const detailed = await getWorkflowDetailedById(workflow.id);
    if (detailed) {
      workflowDetailed = detailed;
    }
  }
} catch (error) {
  console.error('Error fetching detailed workflow:', error);
  // ÈôçÁ∫ßÂà∞Âü∫Á°ÄÂ∑•‰ΩúÊµÅ‰ø°ÊÅØ
}

// Ëé∑ÂèñÁõ∏ÂÖ≥Â∑•‰ΩúÊµÅÔºàÂêåÂàÜÁ±ªÊàñÂêå‰ΩúËÄÖÔºâ
let relatedWorkflows = [];
try {
  if (workflow.categories && workflow.categories.length > 0) {
    const result = await getWorkflows({
      category: workflow.categories[0].toLowerCase().replace(/\s+/g, '-'),
      limit: 4,
      offset: 0,
    });
    // ËøáÊª§ÊéâÂΩìÂâçÂ∑•‰ΩúÊµÅ
    relatedWorkflows = result.workflows.filter((w) => w.id !== workflow.id);
  }
} catch (error) {
  console.error('Error fetching related workflows:', error);
}

// SEO ÈÖçÁΩÆ
const seoConfig = {
  title: `${workflow.title} - N8N Workflows`,
  description: workflow.description || `Download and use this ${workflow.complexityLevel} n8n workflow created by ${workflow.author.name}.`,
  canonical: `/workflows/${slug}`,
  image: workflow.thumbnail,
  type: 'article' as const,
  publishedTime: workflow.publishedAt,
  modifiedTime: workflow.updatedAt,
  author: workflow.author.name,
  tags: workflow.categories,
};

// Èù¢ÂåÖÂ±ëÂØºËà™
const breadcrumbItems = [
  { label: 'Workflows', href: '/' },
  { label: workflow.title }
];
---

<MainLayout {...seoConfig}>
  <div class="w-full min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Breadcrumb -->
      <Breadcrumb items={breadcrumbItems} />

      <!-- Title -->
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mt-4 mb-8">
        {workflow.title}
      </h1>

      <!-- Workflow Preview -->
      <div class="w-full aspect-video bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm mb-8">
        {workflow.sourceUrl ? (
          <iframe
            src={`https://n8n.io/workflows/${workflow.id}/embed`}
            class="w-full h-full border-0"
            title={workflow.title}
          />
        ) : (
          <img
            src={workflow.thumbnail || '/placeholder-workflow.webp'}
            alt={workflow.title}
            class="w-full h-full object-cover"
          />
        )}
      </div>

      <!-- Promo/Ads Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-12">
        <a href="https://s.n8nworkflows.xyz/sYhvf" target="_blank" rel="noopener noreferrer" class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 flex items-center gap-4 hover:shadow-md transition-shadow">
          <div class="w-12 h-12 flex-shrink-0 bg-red-50 rounded-lg flex items-center justify-center">
            <img src="https://n8n.io/favicon.ico" alt="n8n" class="w-8 h-8" />
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-bold text-gray-900 dark:text-white truncate">n8n Cloud</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">$20/month : Unlimited workflows</p>
          </div>
          <span class="text-xs font-bold text-primary-600">Try free</span>
        </a>
        <a href="https://s.n8nworkflows.xyz/MVX4S" target="_blank" rel="noopener noreferrer" class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 flex items-center gap-4 hover:shadow-md transition-shadow">
          <div class="w-12 h-12 flex-shrink-0 bg-blue-50 rounded-lg flex items-center justify-center">
            <img src="https://brightdata.com/favicon.ico" alt="Bright Data" class="w-8 h-8" />
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-bold text-gray-900 dark:text-white truncate">Bright Data</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">#1 Web Scraping Platform</p>
          </div>
          <span class="text-xs font-bold text-primary-600">Try free</span>
        </a>
        <a href="https://s.n8nworkflows.xyz/uhyV1" target="_blank" rel="noopener noreferrer" class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 flex items-center gap-4 hover:shadow-md transition-shadow">
          <div class="w-12 h-12 flex-shrink-0 bg-purple-50 rounded-lg flex items-center justify-center text-xl">üöÄ</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-bold text-gray-900 dark:text-white truncate">Hostinger</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Self-hosted n8n from $4.99</p>
          </div>
          <span class="text-xs font-bold text-primary-600">Try free</span>
        </a>
        <a href="https://s.n8nworkflows.xyz/apify" target="_blank" rel="noopener noreferrer" class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 flex items-center gap-4 hover:shadow-md transition-shadow">
          <div class="w-12 h-12 flex-shrink-0 bg-orange-50 rounded-lg flex items-center justify-center">
            <img src="https://apify.com/favicon.ico" alt="Apify" class="w-8 h-8" />
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-bold text-gray-900 dark:text-white truncate">Apify</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">AI & Automation Hub</p>
          </div>
          <span class="text-xs font-bold text-primary-600">Try free</span>
        </a>
      </div>

      <!-- Main Content - 2 Column Layout -->
      <div class="mt-6">
         <!-- ‰ΩøÁî®Êñ∞ÁöÑ WorkflowDetailedView Â¶ÇÊûúÊúâËØ¶ÊÉÖÂÜÖÂÆπ -->
         {workflowDetailed.overview ||
          workflowDetailed.logicalBlocks ||
          workflowDetailed.nodeDetails ? (
           <WorkflowDetailedView workflow={workflowDetailed} />
         ) : (
           <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
             <div class="lg:col-span-8">
               <WorkflowDetail workflow={workflow} />
             </div>
             <aside class="lg:col-span-4">
               <!-- Sidebar content for basic view -->
               <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 sticky top-8">
                 <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Workflow Info</h3>
                 <div class="space-y-4">
                   <div>
                     <p class="text-sm text-gray-500 dark:text-gray-400">Complexity</p>
                     <p class="text-base font-medium text-gray-900 dark:text-white capitalize">{workflow.complexityLevel}</p>
                   </div>
                   <div>
                     <p class="text-sm text-gray-500 dark:text-gray-400">Nodes</p>
                     <p class="text-base font-medium text-gray-900 dark:text-white">{workflow.nodes}</p>
                   </div>
                   {workflow.version && (
                     <div>
                       <p class="text-sm text-gray-500 dark:text-gray-400">n8n Version</p>
                       <p class="text-base font-medium text-gray-900 dark:text-white">{workflow.version}</p>
                     </div>
                   )}
                 </div>
               </div>
             </aside>
           </div>
         )}
       </div>

      <!-- Related Workflows -->
      {relatedWorkflows.length > 0 && (
        <div class="mt-16">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-8">Related Workflows</h2>
          <RelatedWorkflows workflows={relatedWorkflows} />
        </div>
      )}
    </div>
  </div>
</MainLayout>
