---
/**
 * Â∑•‰ΩúÊµÅËØ¶ÊÉÖÈ°µÔºàÂä®ÊÄÅË∑ØÁî±Ôºâ
 * Â±ïÁ§∫Âçï‰∏™Â∑•‰ΩúÊµÅÁöÑÂÆåÊï¥‰ø°ÊÅØ
 */

import MainLayout from '../../layouts/MainLayout.astro';
import WorkflowDetailedView from '../../components/workflow/WorkflowDetailedView.astro';
import Breadcrumb from '../../components/ui/Breadcrumb.astro';
import { getWorkflows, getWorkflowBySlug, getWorkflowDetailedById } from '../../lib/services/workflows';
import { generateWorkflowSchema, generateBreadcrumbSchema, combineSchemas } from '../../lib/utils/schema';
import type { Workflow, WorkflowDetailed } from '../../lib/types/workflow';

// ÁîüÊàêÈùôÊÄÅË∑ØÂæÑ
export async function getStaticPaths() {
  try {
    const result = await getWorkflows({ limit: 1000, offset: 0 });
    return result.workflows.map((workflow) => ({
      params: { slug: workflow.slug },
      props: { workflow },
    }));
  } catch (error) {
    console.error('Error generating workflow paths:', error);
    return [];
  }
}

const { slug } = Astro.params;
let { workflow } = Astro.props;

// Ëé∑ÂèñËØ¶ÁªÜÂ∑•‰ΩúÊµÅ‰ø°ÊÅØÔºàÂê´ÁªìÊûÑÂåñÂÜÖÂÆπÔºâ
let workflowDetailed: WorkflowDetailed = workflow as WorkflowDetailed;
try {
  if (workflow.id) {
    const detailed = await getWorkflowDetailedById(workflow.id);
    if (detailed) {
      workflowDetailed = detailed;
    }
  }
} catch (error) {
  console.error('Error fetching detailed workflow:', error);
  // ÈôçÁ∫ßÂà∞Âü∫Á°ÄÂ∑•‰ΩúÊµÅ‰ø°ÊÅØ
}

// Ëé∑ÂèñÁõ∏ÂÖ≥Â∑•‰ΩúÊµÅÔºàÂêåÂàÜÁ±ªÊàñÂêå‰ΩúËÄÖÔºâ
let relatedWorkflows: Workflow[] = [];
try {
  if (workflow.categories && workflow.categories.length > 0) {
    const result = await getWorkflows({
      category: workflow.categories[0].toLowerCase().replace(/\s+/g, '-'),
      limit: 4,
      offset: 0,
    });
    // ËøáÊª§ÊéâÂΩìÂâçÂ∑•‰ΩúÊµÅ
    relatedWorkflows = result.workflows.filter((w) => w.id !== workflow.id);
  }
} catch (error) {
  console.error('Error fetching related workflows:', error);
}

// Èù¢ÂåÖÂ±ëÂØºËà™
const breadcrumbItems = [
  { name: 'Workflows', url: '/' },
  { name: workflow.title, url: `/workflows/${slug}` }
];

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://n8nworkflow.com';

// ÁîüÊàêÁªìÊûÑÂåñÊï∞ÊçÆ
const workflowSchema = generateWorkflowSchema(workflow, siteUrl);
const breadcrumbSchema = generateBreadcrumbSchema(breadcrumbItems, siteUrl);
const combinedSchema = combineSchemas(workflowSchema, breadcrumbSchema);

// ËØªÂèñÂ∑•‰ΩúÊµÅ JSON Êï∞ÊçÆ
let workflowJson = null;
try {
  const workflowJsonPath = `/data/workflows/${slug}/${workflow.id}.json`;
  const response = await fetch(new URL(workflowJsonPath, Astro.url.origin));
  if (response.ok) {
    workflowJson = await response.json();
  }
} catch (error) {
  console.error('Error loading workflow JSON:', error);
}

// SEO ÈÖçÁΩÆ
const seoConfig = {
  title: `${workflow.title} - N8N Workflows`,
  description: workflow.description || `Download and use this ${workflow.complexityLevel} n8n workflow created by ${workflow.author.name}.`,
  canonical: `/workflows/${slug}`,
  image: workflow.featuredImage || workflow.thumbnail,
  type: 'article' as const,
  publishedTime: workflow.publishedAt,
  modifiedTime: workflow.updatedAt,
  author: workflow.author.name,
  tags: workflow.categories,
  schema: combinedSchema,
};

---

<MainLayout {...seoConfig}>
  <div class="w-full min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Breadcrumb */}
      <Breadcrumb items={breadcrumbItems.map((item) => ({ label: item.name, href: item.url }))} />

      {/* Title */}
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mt-6 mb-8">
        {workflow.title}
      </h1>

      {/* Workflow Preview with Controls */}
      <div class="w-full mb-8 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 relative" style="height: 635px; --n8n-workflow-min-height: 600px; --n8n-json-background-color: #FDF6F0; --n8n-copy-button-background-color: #FDF6F0;">
        {/* Control Buttons */}
        <div class="absolute top-4 right-4 z-10 flex gap-2">
          <button class="hidden sm:flex p-2 bg-white/90 dark:bg-gray-700/90 rounded-lg shadow-sm hover:shadow-md transition-shadow" title="Fullscreen">
            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
            </svg>
          </button>
          <button class="hidden sm:flex p-2 bg-white/90 dark:bg-gray-700/90 rounded-lg shadow-sm hover:shadow-md transition-shadow" title="Zoom In">
            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
            </svg>
          </button>
          <button class="hidden sm:flex p-2 bg-white/90 dark:bg-gray-700/90 rounded-lg shadow-sm hover:shadow-md transition-shadow" title="Zoom Out">
            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
            </svg>
          </button>
          <button class="p-2 bg-white/90 dark:bg-gray-700/90 rounded-lg shadow-sm hover:shadow-md transition-shadow" title="Reset">
            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
          </button>
        </div>

        {workflowJson ? (
          <div class="workflow-preview-container" style="--n8n-workflow-min-height: 600px; --n8n-json-background-color: #FDF6F0;" data-astro-cid-k6bappp3>
            <script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2.0.0/webcomponents-loader.js" crossorigin="anonymous" data-cfasync="false"></script>
            <script src="https://www.unpkg.com/lit@2.0.0-rc.2/polyfill-support.js" crossorigin="anonymous" data-cfasync="false"></script>
            <script type="module" src="https://cdn.jsdelivr.net/npm/@n8n_io/n8n-demo-component/n8n-demo.bundled.js" crossorigin="anonymous" data-cfasync="false"></script>
            <script type="4994abcb98f644aea97c64c4-text/javascript">
              document.addEventListener('DOMContentLoaded', function() {
                setTimeout(function() {
                  const footers = document.querySelectorAll('.workflow-canvas-footer');
                  footers.forEach(function(footer) {
                    footer.style.display = 'none';
                  });
                }, 1000);
              });
            </script>
            <n8n-demo workflow={JSON.stringify(workflowJson)} theme="light" frame="false" clicktointeract="true" disableinteractivity="false" hidecanvaserrors="true" collapseformobile="true" data-astro-cid-k6bappp3="true"></n8n-demo>
          </div>
        ) : (
          <img
            src={workflow.featuredImage || '/placeholder-workflow.webp'}
            alt={workflow.title}
            class="w-full h-full object-cover rounded-lg"
          />
        )}
      </div>

      {/* Promo/Ads Row */}
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-12">
        <a href="https://s.n8nworkflows.xyz/sYhvf" target="_blank" rel="noopener noreferrer" class="group block rounded-lg border border-primary-200 dark:border-primary-700 bg-gradient-to-r from-primary-50 to-primary-100 dark:from-primary-900/20 dark:to-primary-800/20 px-4 py-3 hover:shadow-md transition">
          <div class="flex flex-col items-center justify-center text-center gap-[20px] h-full">
            <span class="inline-flex items-center justify-center bg-white dark:bg-white border border-gray-200 dark:border-gray-300 rounded px-2 py-1 shadow-sm">
              <img src="/n8n_logo.png" alt="n8n" class="ad-logo-n8n h-[1.25rem] md:h-[1.375rem] w-auto object-contain align-middle" loading="lazy" decoding="async">
            </span>
            <div>
              <div class="font-bold text-[16px] text-gray-900 dark:text-white">$20/month : Unlimited workflows</div>
              <div class="text-[15px] text-gray-600 dark:text-gray-300">2500 executions/month</div>
            </div>
            <span class="inline-flex items-center gap-1 text-[13px] md:text-[13px] font-medium text-white bg-primary-500 group-hover:bg-primary-600 rounded-md px-2.5 py-1">
              Try for free
              <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M13 7l5 5-5 5M6 12h12"></path>
              </svg>
            </span>
          </div>
        </a>
        <a href="https://s.n8nworkflows.xyz/MVX4S" target="_blank" rel="noopener noreferrer" class="group block rounded-lg border border-blue-200 dark:border-blue-700 bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 px-4 py-3 hover:shadow-md transition">
          <div class="flex flex-col items-center justify-center text-center gap-[20px] h-full">
            <span class="inline-flex items-center justify-center bg-white dark:bg-white border border-gray-200 dark:border-gray-300 rounded px-2 py-1 shadow-sm">
              <img src="/brightdata.png" alt="Bright Data" class="h-5 w-auto" loading="lazy" decoding="async">
            </span>
            <div>
              <div class="font-bold text-[16px] text-gray-900 dark:text-white">THE #1 IN WEB SCRAPING</div>
              <div class="text-[15px] text-gray-700 dark:text-gray-300">Scrape any website without limits</div>
            </div>
            <span class="inline-flex items-center gap-1 text-[13px] md:text-[13px] font-medium text-white rounded-md px-2.5 py-1" style="background-color:#0057FF;">
              Try for free
              <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M13 7l5 5-5 5M6 12h12"></path>
              </svg>
            </span>
          </div>
        </a>
        <a href="https://s.n8nworkflows.xyz/uhyV1" target="_blank" rel="noopener noreferrer" class="group flex items-center justify-center rounded-lg border border-purple-200 dark:border-purple-700 bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 px-4 py-3 hover:shadow-md transition">
          <div class="flex flex-col items-center justify-center text-center gap-[20px] min-w-0 w-full h-full">
            <span class="text-[10px] font-bold px-2 py-1 rounded" style="background-color:#673DE6;color:white;">HOSTINGER</span>
            <span class="text-[13px] font-bold px-4 py-2 rounded text-white text-center" style="background-color:#673DE6;">üéâ Early Black Friday Deal<br>DISCOUNT 20%</span>
            <div>
              <div class="font-bold text-[16px] text-gray-900 dark:text-white">Self-hosted n8n</div>
              <div class="text-[15px] text-gray-600 dark:text-gray-300">Unlimited workflows - from $4.99/mo</div>
            </div>
            <span class="inline-flex items-center gap-1 text-[13px] md:text-[13px] font-medium text-white rounded-md px-2.5 py-1" style="background-color:#673DE6;">
              Try for free
              <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M13 7l5 5-5 5M6 12h12"></path>
              </svg>
            </span>
          </div>
        </a>
        <a href="https://s.n8nworkflows.xyz/apify" target="_blank" rel="noopener noreferrer" class="group flex items-center justify-center rounded-lg border border-amber-200 dark:border-amber-700 bg-gradient-to-r from-amber-50 to-amber-100 dark:from-amber-900/20 dark:to-amber-800/20 px-4 py-3 hover:shadow-md transition">
          <div class="flex flex-col items-center justify-center text-center gap-[20px] min-w-0 w-full h-full">
            <span class="inline-flex items-center justify-center bg-white dark:bg-white border border-gray-200 dark:border-gray-300 rounded px-2.5 py-1 shadow-sm">
              <img src="/apifylogo.svg" alt="Apify" class="h-5 w-auto" loading="lazy" decoding="async">
            </span>
            <div>
              <div class="font-bold text-[16px] text-gray-900 dark:text-white">#1 hub for scraping, AI & automation</div>
              <div class="text-[15px] text-gray-600 dark:text-gray-300">6000+ actors - $5 credits/mo</div>
            </div>
            <span class="inline-flex items-center gap-1 text-[13px] md:text-[13px] font-medium text-white rounded-md px-2.5 py-1" style="background-color:#FF8A00;">
              Try for free
              <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M13 7l5 5-5 5M6 12h12"></path>
              </svg>
            </span>
          </div>
        </a>
      </div>

      {/* Detailed Content Section */}
      <WorkflowDetailedView workflow={workflowDetailed} relatedWorkflows={relatedWorkflows} />

    </div>
  </MainLayout>
