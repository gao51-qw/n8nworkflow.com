---
/**
 * 工作流详情页（动态路由）
 * 展示单个工作流的完整信息
 */

import MainLayout from '../../layouts/MainLayout.astro';
import WorkflowDetailedView from '../../components/workflow/WorkflowDetailedView.astro';
import Breadcrumb from '../../components/ui/Breadcrumb.astro';
import AdRow from '../../components/ui/AdRow.astro';
import { getWorkflows, getWorkflowBySlug, getWorkflowDetailedById } from '../../lib/services/workflows';
import { generateWorkflowSchema, generateBreadcrumbSchema, combineSchemas } from '../../lib/utils/schema';
import type { Workflow, WorkflowDetailed } from '../../lib/types/workflow';

// 生成静态路径
export async function getStaticPaths() {
  try {
    const result = await getWorkflows({ limit: 1000, offset: 0 });
    return result.workflows.map((workflow) => ({
      params: { slug: workflow.slug },
      props: { workflow },
    }));
  } catch (error) {
    console.error('Error generating workflow paths:', error);
    return [];
  }
}

const { slug } = Astro.params;
let { workflow } = Astro.props;

// 如果 workflow 不存在（例如在 SSR 模式下），尝试按 slug 获取
if (!workflow && slug) {
  const result = await getWorkflowBySlug(slug);
  if (result) {
    workflow = result;
  }
}

// 如果仍然没有找到工作流，重定向到 404
if (!workflow) {
  return Astro.redirect('/404');
}

// 获取详细工作流信息（含结构化内容）
let workflowDetailed: WorkflowDetailed = workflow as WorkflowDetailed;
try {
  if (workflow.id) {
    const detailed = await getWorkflowDetailedById(workflow.id);
    if (detailed) {
      workflowDetailed = detailed;
    }
  }
} catch (error) {
  console.error('Error fetching detailed workflow:', error);
  // 降级到基础工作流信息
}

// 获取相关工作流（同分类或同作者）
let relatedWorkflows: Workflow[] = [];
try {
  if (workflow.categories && workflow.categories.length > 0) {
    const result = await getWorkflows({
      category: workflow.categories[0].toLowerCase().replace(/\s+/g, '-'),
      limit: 4,
      offset: 0,
    });
    // 过滤掉当前工作流
    relatedWorkflows = result.workflows.filter((w) => w.id !== workflow.id);
  }
} catch (error) {
  console.error('Error fetching related workflows:', error);
}

// 面包屑导航
const breadcrumbItems = [
  { name: 'Workflows', url: '/' },
  { name: workflow.title, url: `/workflows/${slug}` }
];

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://n8nworkflow.com';

// 生成结构化数据
const workflowSchema = generateWorkflowSchema(workflow, siteUrl);
const breadcrumbSchema = generateBreadcrumbSchema(breadcrumbItems, siteUrl);
const combinedSchema = combineSchemas(workflowSchema, breadcrumbSchema);

// 验证工作流 JSON 是否有效
function validateWorkflowJson(json: any): boolean {
  if (!json) return false;
  if (!json.name || typeof json.name !== 'string') return false;
  if (!json.nodes || !Array.isArray(json.nodes)) return false;
  if (!json.connections || typeof json.connections !== 'object') return false;
  if (json.nodes.length === 0) return false;
  return true;
}

// 读取工作流 JSON 数据
let workflowJson = null;
try {
  // 尝试从多个可能的路径读取工作流 JSON
  const possiblePaths = [
    `/data/workflows/${slug}/${workflow.id}.json`,
    `/data/workflows/${workflow.id}/${workflow.id}.json`,
    `/data/workflows/${slug}/${slug}.json`
  ];
  
  for (const path of possiblePaths) {
    const response = await fetch(new URL(path, Astro.url.origin));
    if (response.ok) {
      const fullData = await response.json();
      
      // 万能提取公式：处理 api.n8n.io 的双重嵌套、标准嵌套、字符串化嵌套及扁平结构
      const extractWorkflow = (data: any) => {
        let workflowObj = data;
        
        // 处理第一层嵌套
        if (data.workflow) {
          if (typeof data.workflow === 'object') {
            workflowObj = data.workflow;
          } else if (typeof data.workflow === 'string') {
            try { workflowObj = JSON.parse(data.workflow); } catch (e) {}
          }
        }

        // 处理第二层嵌套 (api.n8n.io 格式)
        let core = workflowObj;
        if (workflowObj.workflow) {
          if (typeof workflowObj.workflow === 'object') {
            core = workflowObj.workflow;
          } else if (typeof workflowObj.workflow === 'string') {
            try { core = JSON.parse(workflowObj.workflow); } catch (e) {}
          }
        }

        // 严格按照主站逻辑构建，确保字段完整
        return {
          name: data.name || workflowObj.name || core.name || workflow.title,
          nodes: core.nodes || workflowObj.nodes || data.nodes || [],
          connections: core.connections || workflowObj.connections || data.connections || {},
          settings: core.settings || workflowObj.settings || data.settings || {},
          active: false,
          id: data.id || workflowObj.id || core.id,
          createdAt: data.createdAt || workflowObj.createdAt || core.createdAt,
          updatedAt: data.updatedAt || workflowObj.updatedAt || core.updatedAt || data.createdAt || workflowObj.createdAt || core.createdAt
        };
      };

      workflowJson = extractWorkflow(fullData);
      
      // 验证 JSON 格式
      if (validateWorkflowJson(workflowJson)) {
        break;
      } else {
        console.error(`Invalid workflow JSON structure at ${path}:`, workflowJson);
        workflowJson = null;
      }
    }
  }
} catch (error) {
  console.error('Error loading workflow JSON:', error);
}

// SEO 配置
const seoConfig = {
  title: `${workflow.title} - N8N Workflows`,
  description: workflow.description || `Download and use this ${workflow.complexityLevel} n8n workflow created by ${workflow.author.name}.`,
  canonical: `/workflows/${slug}`,
  image: workflow.featuredImage || workflow.thumbnail,
  type: 'article' as const,
  publishedTime: workflow.publishedAt,
  modifiedTime: workflow.updatedAt,
  author: workflow.author.name,
  tags: workflow.categories,
  schema: combinedSchema,
};

---

<MainLayout {...seoConfig}>
  <div class="w-full min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Breadcrumb */}
      <Breadcrumb items={breadcrumbItems.map((item) => ({ label: item.name, href: item.url }))} />

      {/* Title */}
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mt-6 mb-8">
        {workflow.title}
      </h1>

      {/* Workflow Preview with Controls */}
      <div class="w-full mb-8 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 relative" style="height: 635px; --n8n-workflow-min-height: 600px; --n8n-json-background-color: #FDF6F0; --n8n-copy-button-background-color: #FDF6F0;">
        {/* Control Buttons */}
        <div class="absolute top-4 right-4 z-10 flex gap-2">
          <button class="hidden sm:flex p-2 bg-white/90 dark:bg-gray-700/90 rounded-lg shadow-sm hover:shadow-md transition-shadow" title="Fullscreen">
            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
            </svg>
          </button>
          <button class="hidden sm:flex p-2 bg-white/90 dark:bg-gray-700/90 rounded-lg shadow-sm hover:shadow-md transition-shadow" title="Zoom In">
            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
            </svg>
          </button>
          <button class="hidden sm:flex p-2 bg-white/90 dark:bg-gray-700/90 rounded-lg shadow-sm hover:shadow-md transition-shadow" title="Zoom Out">
            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
            </svg>
          </button>
          <button class="p-2 bg-white/90 dark:bg-gray-700/90 rounded-lg shadow-sm hover:shadow-md transition-shadow" title="Reset">
            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
          </button>
        </div>

        {workflowJson ? (
          <div class="workflow-preview-container" style="--n8n-workflow-min-height: 600px; --n8n-json-background-color: #FDF6F0;" data-astro-cid-k6bappp3>
            <script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2.0.0/webcomponents-loader.js" crossorigin="anonymous" data-cfasync="false"></script>
            <script src="https://www.unpkg.com/lit@2.0.0-rc.2/polyfill-support.js" crossorigin="anonymous" data-cfasync="false"></script>
            <script type="module" src="https://cdn.jsdelivr.net/npm/@n8n_io/n8n-demo-component/n8n-demo.bundled.js" crossorigin="anonymous" data-cfasync="false"></script>
            
            {/* 直接在 HTML 属性中传递 workflow JSON */}
            <n8n-demo 
              workflow={JSON.stringify(workflowJson)}
              theme="light" 
              frame="false" 
              clicktointeract="true" 
              disableinteractivity="false" 
              hidecanvaserrors="true" 
              collapseformobile="true" 
              data-astro-cid-k6bappp3="true">
            </n8n-demo>
            
            <script is:inline>
              // 隐藏底部页脚
              setTimeout(function() {
                const footers = document.querySelectorAll('.workflow-canvas-footer');
                footers.forEach(function(footer) {
                  footer.style.display = 'none';
                });
              }, 1000);
            </script>
          </div>
        ) : (
          <img
            src={workflow.featuredImage || '/placeholder-workflow.webp'}
            alt={workflow.title}
            class="w-full h-full object-cover rounded-lg"
          />
        )}
      </div>

      {/* Promo/Ads Row */}
      <AdRow variant="detailed" />

      {/* Detailed Content Section */}
      <WorkflowDetailedView workflow={workflowDetailed} relatedWorkflows={relatedWorkflows} />

    </div>
  </MainLayout>
