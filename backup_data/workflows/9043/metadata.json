{
  "id": 9043,
  "slug": "9043",
  "title": "WhatsApp support bot with Google Drive RAG, GPT-4.1-mini and Cohere reranking",
  "description": "# WhatsApp RAG Agent (Text + Voice) with Weekly Google Drive Sync\n\n**One-line summary :** Answers WhatsApp in under 100 words, understands voice notes, and retrieves trusted answers from your Google Drive docs (RAG) kept fresh weekly.\n\n---\n\n## What this template does\n\n* **Reply to WhatsApp messages** in a polite, human tone with **≤100 words**.\n* **Understands text and voice notes**: auto-downloads audio and transcribes to text.\n* **Retrieves answers from your knowledge base (RAG)**: Google Drive docs → chunk → embed → store in Supabase → rerank with Cohere.\n* **Keeps short-term memory** across the conversation to avoid repetition.\n* **Weekly doc sync** from a selected Google Drive folder so non-technical staff can update content without touching n8n.\n\n---\n\n## Why it matters\n\n* **Zero busywork:** Update a Google Doc; the bot learns it on the next sync.\n* **Trustworthy answers:** Responses come from **your** vetted docs, not random web text.\n* **Voice-first friendly:** Handles the WhatsApp reality of “send a voice note.”\n* **Safer by design:** Guardrails—no pricing unless in KB, no pushy sales, no medical advice.\n\n---\n\n## Triggers\n\n* **WhatsApp Trigger:** Receives incoming messages (text or audio).\n* **Google Drive Trigger (weekly):** Detects new/updated files in the chosen folder for ingestion.\n\n---\n\n## App credentials required\n\n* **WhatsApp Business Cloud** (App ID, Token, Phone Number ID)\n* **OpenAI** (Chat + Embeddings)\n* **Cohere** (Rerank)\n* **Supabase** (SUPABASE_URL, ANON_KEY)\n* **Google Drive** (OAuth2) + target Folder ID\n\n---\n\n## Suggested environment variables\n\n```bash\nWHATSAPP_APP_ID=\nWHATSAPP_TOKEN=\nWHATSAPP_PHONE_NUMBER_ID=\nOPENAI_API_KEY=\nCOHERE_API_KEY=\nSUPABASE_URL=\nSUPABASE_ANON_KEY=\nGDRIVE_FOLDER_ID=\nRAG_TABLE_NAME=\"documents\"     # table to store vectors/metadata\nMAX_ANSWER_WORDS=100            # guardrail for concise replies\n```\n\n---\n\n## Architecture overview\n\n* **Answer-time lane (RAG Tool):**\n\n  1. Receive WhatsApp message → 2) Transcribe audio if present → 3) Maintain short-term memory → 4) Retrieve from Supabase vectors (topK) → 5) Rerank with Cohere → 6) Compose ≤100-word reply with sources → 7) Send on WhatsApp.\n* **Ingest lane (Weekly Sync):**\n  A) Detect Drive file updates → B) Download & convert (Docs → text/plain) → C) Chunk (size/overlap) → D) Embed with OpenAI → E) Upsert to Supabase with metadata & hashes.\n\n---\n\n## How it works (node rundown)\n\n| #  | Node                                        | Key Inputs                      | Key Outputs                       |\n| -- | ------------------------------------------- | ------------------------------- | --------------------------------- |\n| 1  | **WhatsApp Trigger**                        | Incoming message                | Raw WhatsApp payload              |\n| 2  | **Switch** (Attachment presence/type)       | Payload                         | Route: **Text** or **Audio**      |\n| 3  | **HTTP Request** (Audio path)               | `attachments[0].data_url`       | Audio file                        |\n| 4  | **OpenAI – Translate/ASR**                  | Audio file                      | Transcribed text                  |\n| 5  | **Merge**                                   | Text path + Audio path          | Unified text message              |\n| 6  | **Simple Memory**                           | Recent turns                    | Short-term context                |\n| 7  | **OpenAI Chat Model**                       | Prompt + message + memory       | Draft answer (tool calls allowed) |\n| 8  | **Supabase Vector Tool (retrieve-as-tool)** | Query text, `topK=10`           | Candidate KB passages             |\n| 9  | **Cohere Reranker**                         | Candidates                      | Re-ranked context                 |\n| 10 | **Send WhatsApp Message**                   | `to`, `body`                    | Reply sent                        |\n| 11 | **Google Drive Trigger (weekly)**           | Folder ID, `fileUpdated`        | Changed files                     |\n| 12 | **Set (File Id)**                           | id from trigger                 | File ref                          |\n| 13 | **Google Drive – Download File**            | Id (Docs→txt)                   | Raw text                          |\n| 14 | **Character Text Splitter**                 | `chunkSize=2000`, `overlap=300` | Chunks                            |\n| 15 | **Default Data Loader**                     | Binary→Document                 | Clean docs                        |\n| 16 | **OpenAI Embeddings (ingest)**              | Chunks                          | Vectors                           |\n| 17 | **Supabase Vector Store (insert)**          | Table: `documents`              | Upserted KB                       |\n\n**Notes**\n\n* The **KB Tool** is the combo of steps 8–9–7 at answer time (retrieve → rerank → answer).\n* The **Ingest lane** is steps 11–17 (weekly sync of your Drive folder).\n\n---\n\n## Setup (7‑minute sprint)\n\n1. **Import the workflow** JSON.\n2. **Connect credentials:** WhatsApp, OpenAI, Cohere, Supabase, Google Drive.\n3. **Google Drive Trigger:** paste your **Folder ID**; keep `fileUpdated` event.\n4. **Download File:** ensure Google Docs convert to **text/plain**.\n5. **Supabase Vector Store (insert):** set table name to **`documents`** (or your schema).\n6. **Character Text Splitter:** keep `chunkSize=2000`, `overlap=300` (balanced recall/latency).\n7. **Retrieve-as-tool:** set `topK=10` and **enable reranker**.\n8. **Send WhatsApp Message** mapping:\n\n   * **Recipient**: `{{$(\"WhatsApp Trigger\").item.json.messages[0].from}}`\n   * **Body**: `{{$json.output}}`\n9. **Test:**\n\n   * Send a **text** and a **voice note** to your WhatsApp number → confirm concise answers.\n   * Drop a Google Doc into the watched folder → verify it’s chunked/embedded on the next weekly poll (or run ingest nodes once manually).\n\n---\n\n## Prompt, tone & guardrails\n\n* **System prompt:**\n\n  * Be polite, human, and concise (**≤ `MAX_ANSWER_WORDS`**).\n  * Cite or reference **only** the KB content; if unknown, say so and offer to escalate.\n  * **No prices** unless present in the KB. **No medical advice.**\n* **Temperature:** start at **0.2** for factual replies.\n* **Memory window:** keep a short rolling buffer (e.g., last 4–6 turns).\n\n---\n\n## Data model (minimum viable)\n\nTable **`documents`** (example columns):\n\n* `id` (uuid)\n* `source_url` (text)\n* `title` (text)\n* `chunk` (text)\n* `embedding` (vector/float[] depending on extension)\n* `chunk_hash` (text)\n* `updated_at` (timestamp)\n\n**Indexes**\n\n* Unique index on `chunk_hash` to dedupe\n* Index on `updated_at` for syncs\n\n---\n\n## Observability & ops\n\n* Log **question**, **selected chunk ids/hashes**, and **final response** to a DB/Sheet for QA.\n* Add a **low-confidence** route (score threshold) → Slack/Telegram escalation to a human.\n* Track **latency** and **token usage** to tune `topK` and chunk sizes.\n\n---\n\n## Customization\n\n* **Latency vs quality:** try `topK=6–8` and `chunkSize=1200` for speed.\n* **Languages:** ASR node can be swapped for native multilingual output.\n* **Escalation:** add channel handoff on low confidence or no KB hits.\n* **Sync cadence:** change Drive Trigger to **daily** if content updates frequently.\n\n---\n\n## Safety & compliance\n\n* **No medical advice.** If uncertain or clinical, ask to schedule a consult or refer to the right department.\n* **PII:** Don’t log full phone numbers in plaintext analytics; hash where possible.\n* **Prices & rates:** Only answer if present in the KB; otherwise hand off to front desk.\n\n---\n\n## Troubleshooting\n\n* **No reply sent:** Ensure **Send message** node reads `{{$json.output}}` (Agent’s response property).\n* **Audio path failing:** Confirm `attachments[0].data_url` exists and HTTP node fetches a valid file.\n* **KB not updating:** Manually execute the ingest lane; check rows in Supabase.\n* **Irrelevant answers:** Lower temperature to **0.2**, increase overlap to **400**, and verify Drive docs are clean and structured.\n\n---\n\n## Categories & tags\n\n* **Categories:** AI, Customer Support, Healthcare Ops, RAG, WhatsApp\n* **Tags:** WhatsApp, RAG, Google Drive, Supabase, OpenAI, Cohere, Voice Notes\n\n---\n\n## Pricing (rough, BYO keys)\n\n* **n8n:** self-host free; n8n.cloud billed by plan.\n* **OpenAI, Cohere:** usage-based by tokens/calls.\n* **Supabase:** free tier + usage; vector storage billed by size.\n* **WhatsApp Cloud:** Meta pricing per conversation.\n\n---\n\n## Nodes used in workflow\n\n**WhatsApp Trigger**, **Switch**, **HTTP Request**, **OpenAI (ASR + Chat + Embeddings)**, **Merge**, **Simple Memory**, **Supabase Vector Tool (retrieve)**, **Cohere Reranker**, **Google Drive Trigger**, **Set**, **Google Drive – Download**, **Character Text Splitter**, **Default Data Loader**.\n\n",
  "featuredImage": "/data/workflows/9043/9043.webp",
  "author": {
    "id": 101,
    "slug": "basil",
    "name": "Basil Irfan",
    "avatar": ""
  },
  "categories": [
    "Support Chatbot",
    "AI RAG"
  ],
  "complexityLevel": "advanced",
  "price": 0,
  "visitors": 636,
  "downloads": 63,
  "createdAt": "2025-09-28T12:09:25.137Z",
  "updatedAt": "2026-01-16T08:58:50.200Z",
  "publishedAt": "2025-09-28T12:09:25.137Z",
  "nodes": 25,
  "version": "1.0.0",
  "sourceUrl": "https://n8n.io/workflows/9043"
}